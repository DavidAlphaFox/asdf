;;; -*- Lisp -*-

(defparameter asd (subpathname *test-directory* "test-multiple.asd"))
(defparameter tmp (subpathname *test-directory* "../build/"))
(defparameter asd2 (subpathname tmp "test-multiple-too.asd"))
(defparameter file4 (test-fasl "file4"))
(setf *central-registry* `(,*test-directory* ,tmp))

;; Don't rely on ln -s on Windows
(defparameter symlinkp
  (progn
    #+os-unix
    (zerop
     (nth-value 2
                (run-program
                 `("ln" "-sf" ,(native-namestring asd) ,(native-namestring asd2))
                 :output t :error-output t :input nil :ignore-error-status t)))))
(defmacro with-bad-system-names (&body body)
  `(handler-bind ((bad-system-name #'(lambda (c) (muffle-warning c))))
     ,@body))

(with-bad-system-names
 (oos 'load-source-op (if symlinkp 'test-multiple-too 'test-multiple)))
(assert (asymval :*file2* :test-package))
(with-bad-system-names
 (load-system 'test-multiple-free))
(assert (probe-file* file4))
(assert (asymval :*file4* :test-package))
(setf test-package::*file4* nil)
(with-bad-system-names
    (load-system 'test-multiple-free))
(assert-equal test-package::*file4* nil)
